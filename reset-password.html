<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Réinitialiser le mot de passe</title>
</head>
<body>

<h2>Changer le mot de passe</h2>

<form id="reset-form">
  <input type="password" id="password" placeholder="Nouveau mot de passe" required />
  <button type="submit">Modifier</button>
</form>

<p id="message"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supa = createClient(
  'https://kkgguofgpzdlgtbzvnzn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZ2d1b2ZncHpkbGd0Ynp2bnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTI3MTgsImV4cCI6MjA4NjU2ODcxOH0.4BP8UbxgRa3ZSueS9XBNpx3JEG9yz7Un97RnoHh1Ksc'
);

const message = document.getElementById("message");

// 1️⃣ Récupérer les tokens du hash (#)
const hash = window.location.hash.substring(1);
const params = new URLSearchParams(hash);

const access_token = params.get("access_token");
const refresh_token = params.get("refresh_token");

if (!access_token || !refresh_token) {
  message.textContent = "Lien invalide ou expiré.";
} else {

  // 2️⃣ Créer la session
  const { error: sessionError } = await supa.auth.setSession({
    access_token,
    refresh_token
  });

  if (sessionError) {
    message.textContent = "Session invalide.";
  }

  // 3️⃣ Gérer le changement de mot de passe
  document.getElementById("reset-form")
  .addEventListener("submit", async (e) => {
    e.preventDefault();

    const password = document.getElementById("password").value;

    if (password.length < 6) {
      message.textContent = "Le mot de passe doit contenir au moins 6 caractères.";
      return;
    }

    const { error } = await supa.auth.updateUser({
      password: password
    });

    if (error) {
      message.textContent = "Erreur : " + error.message;
    } else {
      message.textContent = "Mot de passe changé avec succès !";

      // Nettoyer le hash de l’URL
      window.history.replaceState({}, document.title, window.location.pathname);

      setTimeout(() => {
        window.location.href = "/connexion.html";
      }, 2000);
    }
  });
}
</script>

</body>
</html>