<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Réinitialiser le mot de passe</title>
</head>
<body>

<h2>Changer le mot de passe</h2>

<form id="reset-form">
  <input type="password" id="password" placeholder="Nouveau mot de passe" required />
  <button type="submit">Modifier</button>
</form>

<p id="message"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supab = createClient(
  'https://kkgguofgpzdlgtbzvnzn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZ2d1b2ZncHpkbGd0Ynp2bnpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTI3MTgsImV4cCI6MjA4NjU2ODcxOH0.4BP8UbxgRa3ZSueS9XBNpx3JEG9yz7Un97RnoHh1Ksc'
);

// 1️⃣ Récupérer les tokens depuis le hash
const hashParams = new URLSearchParams(window.location.hash.substring(1));
const access_token = hashParams.get("access_token");
const refresh_token = hashParams.get("refresh_token");

if (!access_token || !refresh_token) {
  document.getElementById("message").textContent = "Lien invalide ou expiré.";
}

// 2️⃣ Créer la session avec les tokens
await supab.auth.setSession({ access_token, refresh_token });

// 3️⃣ Écouter le submit du formulaire
document.getElementById("reset-form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const nouveauMotDePasse = document.getElementById("password").value;

  // 4️⃣ Changer le mot de passe directement
  const { error } = await supab.auth.updateUser({
    password: nouveauMotDePasse
  });

  if (error) {
    document.getElementById("message").textContent = "Erreur : " + error.message;
  } else {
    document.getElementById("message").textContent = "Mot de passe changé avec succès !";
    // Optionnel : rediriger vers login après 2 secondes
    setTimeout(() => window.location.href = "/login.html", 2000);
  }
});
</script>

</body>
</html>